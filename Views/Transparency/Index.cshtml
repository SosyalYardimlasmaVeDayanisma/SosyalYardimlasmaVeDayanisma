@model TransparencyStats
@{
    ViewData["Title"] = "ÅeffaflÄ±k";
}

<div class="container page-container">
    <div class="mb-8">
        <h1 class="page-title">ÅeffaflÄ±k Raporu ğŸ“Š</h1>
        <p class="page-description">
            Platform istatistikleri, baÄŸÄ±ÅŸ verileri ve yardÄ±m daÄŸÄ±lÄ±mlarÄ±. 
            Her baÄŸÄ±ÅŸÄ±n nereye gittiÄŸini, kaÃ§ kiÅŸiye ulaÅŸtÄ±ÄŸÄ±nÄ± ve toplumsal etkisini ÅŸeffaflÄ±kla paylaÅŸÄ±yoruz.
        </p>
    </div>

    <div class="stats-grid" style="margin-bottom: 32px;">
        <div class="card stat-card">
            <h3 style="font-size: 15px; font-weight: 600; color: var(--text-secondary); margin-bottom: 12px; text-transform: uppercase; letter-spacing: 0.8px;">Toplam YardÄ±m</h3>
            <div style="font-size: 36px; font-weight: 900; color: var(--primary);">â‚º@Model.TotalDonations.ToString("N0")</div>
        </div>
        <div class="card stat-card">
            <h3 style="font-size: 15px; font-weight: 600; color: var(--text-secondary); margin-bottom: 12px; text-transform: uppercase; letter-spacing: 0.8px;">Aktif Kampanyalar</h3>
            <div style="font-size: 36px; font-weight: 900; color: var(--primary);">@Model.TotalCampaigns</div>
        </div>
        <div class="card stat-card">
            <h3 style="font-size: 15px; font-weight: 600; color: var(--text-secondary); margin-bottom: 12px; text-transform: uppercase; letter-spacing: 0.8px;">Ä°yilik Yapanlar</h3>
            <div style="font-size: 36px; font-weight: 900; color: var(--primary);">@Model.TotalParticipants.ToString("N0")</div>
        </div>
        <div class="card stat-card">
            <h3 style="font-size: 15px; font-weight: 600; color: var(--text-secondary); margin-bottom: 12px; text-transform: uppercase; letter-spacing: 0.8px;">Ortalama YardÄ±m</h3>
            <div style="font-size: 36px; font-weight: 900; color: var(--primary);">â‚º@Model.AvgDonation.ToString("N0")</div>
        </div>
    </div>

    <div class="grid grid-2" style="gap: 24px; margin-bottom: 32px;">
        <div class="card">
            <div class="card-body">
                <h3 style="font-weight: 600; margin-bottom: 16px;">NasÄ±l Ã‡alÄ±ÅŸÄ±r?</h3>
                <div class="space-y-4">
                    <div>
                        <h4 style="font-weight: 700; margin-bottom: 10px; color: var(--primary); font-size: 18px;">1. Ä°yilik AlanÄ± SeÃ§in</h4>
                        <p class="text-secondary" style="font-size: 15px; line-height: 1.8;">Afet, hayvan, Ã§ocuk, doÄŸa veya diÄŸer kategorilerden size en yakÄ±n kampanyayÄ± seÃ§in ve katkÄ± saÄŸlayÄ±n.</p>
                    </div>
                    <div>
                        <h4 style="font-weight: 700; margin-bottom: 10px; color: var(--primary); font-size: 18px;">2. Ä°yilik PuanÄ± KazanÄ±n</h4>
                        <p class="text-secondary" style="font-size: 15px; line-height: 1.8;">Her 10 TL katkÄ± iÃ§in 1 iyilik puanÄ± kazanÄ±rsÄ±nÄ±z. Ne kadar Ã§ok katkÄ±, o kadar Ã§ok puan!</p>
                    </div>
                    <div>
                        <h4 style="font-weight: 700; margin-bottom: 10px; color: var(--primary); font-size: 18px;">3. Ä°yiliÄŸi BÃ¼yÃ¼tÃ¼n</h4>
                        <p class="text-secondary" style="font-size: 15px; line-height: 1.8;">KazandÄ±ÄŸÄ±nÄ±z iyilik puanlarÄ±yla destekÃ§i iÅŸletmelerden indirimler alabilir, iyilik dÃ¶ngÃ¼sÃ¼nÃ¼ bÃ¼yÃ¼tebilirsiniz.</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-body">
                <h3 style="font-weight: 600; margin-bottom: 20px;">KatkÄ± DaÄŸÄ±lÄ±mÄ± ğŸ“ˆ</h3>
                <div class="space-y-4">
                    <div>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <span style="font-weight: 600; font-size: 14px; color: var(--text-primary);">ğŸšï¸ Afet & Acil YardÄ±m</span>
                            <span style="font-weight: 700; color: var(--primary);">42%</span>
                        </div>
                        <div style="height: 8px; background: #e5e7eb; border-radius: 999px; overflow: hidden;">
                            <div style="height: 100%; width: 42%; background: linear-gradient(90deg, var(--primary) 0%, #059669 100%); border-radius: 999px;"></div>
                        </div>
                    </div>
                    <div>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <span style="font-weight: 600; font-size: 14px; color: var(--text-primary);">ğŸ‘¶ Ã‡ocuk & EÄŸitim</span>
                            <span style="font-weight: 700; color: var(--primary);">28%</span>
                        </div>
                        <div style="height: 8px; background: #e5e7eb; border-radius: 999px; overflow: hidden;">
                            <div style="height: 100%; width: 28%; background: linear-gradient(90deg, var(--primary) 0%, #059669 100%); border-radius: 999px;"></div>
                        </div>
                    </div>
                    <div>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <span style="font-weight: 600; font-size: 14px; color: var(--text-primary);">ğŸ¾ Hayvan RefahÄ±</span>
                            <span style="font-weight: 700; color: var(--primary);">18%</span>
                        </div>
                        <div style="height: 8px; background: #e5e7eb; border-radius: 999px; overflow: hidden;">
                            <div style="height: 100%; width: 18%; background: linear-gradient(90deg, var(--primary) 0%, #059669 100%); border-radius: 999px;"></div>
                        </div>
                    </div>
                    <div>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <span style="font-weight: 600; font-size: 14px; color: var(--text-primary);">ğŸŒ³ Ã‡evre & DoÄŸa</span>
                            <span style="font-weight: 700; color: var(--primary);">12%</span>
                        </div>
                        <div style="height: 8px; background: #e5e7eb; border-radius: 999px; overflow: hidden;">
                            <div style="height: 100%; width: 12%; background: linear-gradient(90deg, var(--primary) 0%, #059669 100%); border-radius: 999px;"></div>
                        </div>
                    </div>
                </div>
                <div style="margin-top: 16px; padding: 12px; background: rgba(16, 185, 129, 0.08); border-radius: 8px; border-left: 3px solid var(--primary);">
                    <p style="font-size: 13px; color: var(--text-secondary); line-height: 1.5; margin: 0;">
                        <strong style="color: var(--text-primary);">ğŸ’¡ Not:</strong> Bu veriler tÃ¼m kullanÄ±cÄ±larÄ±n katkÄ±larÄ±nÄ±n toplamÄ±na gÃ¶re hesaplanmaktadÄ±r.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Ne YapmÄ±yoruz BÃ¶lÃ¼mÃ¼ -->
    <div class="card" style="border: 2px solid rgba(16, 185, 129, 0.15); background: linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(249, 250, 251, 0.95) 100%);">
        <div class="card-body">
            <h3 style="font-weight: 600; margin-bottom: 20px; color: var(--text-primary); font-size: 20px;">Ne YapmÄ±yoruz? ğŸ›¡ï¸</h3>
            <div class="grid grid-2" style="gap: 20px;">
                <div style="padding: 16px; background: white; border-radius: 8px; border-left: 3px solid var(--primary);">
                    <h4 style="font-size: 15px; font-weight: 600; margin-bottom: 8px; color: var(--text-primary);">âŒ Ticari AmaÃ§ Yok</h4>
                    <p style="font-size: 14px; color: var(--text-secondary); line-height: 1.6;">
                        KatkÄ±larÄ±nÄ±z hiÃ§bir ÅŸekilde ticari amaÃ§la kullanÄ±lmaz, kar amacÄ± gÃ¼tmez.
                    </p>
                </div>
                <div style="padding: 16px; background: white; border-radius: 8px; border-left: 3px solid var(--primary);">
                    <h4 style="font-size: 15px; font-weight: 600; margin-bottom: 8px; color: var(--text-primary);">âŒ SÄ±ralama Yok</h4>
                    <p style="font-size: 14px; color: var(--text-secondary); line-height: 1.6;">
                        KullanÄ±cÄ±lar katkÄ± miktarÄ±na gÃ¶re sÄ±ralanmaz, yarÄ±ÅŸtÄ±rÄ±lmaz veya karÅŸÄ±laÅŸtÄ±rÄ±lmaz.
                    </p>
                </div>
                <div style="padding: 16px; background: white; border-radius: 8px; border-left: 3px solid var(--primary);">
                    <h4 style="font-size: 15px; font-weight: 600; margin-bottom: 8px; color: var(--text-primary);">âŒ Gizli Kesinti Yok</h4>
                    <p style="font-size: 14px; color: var(--text-secondary); line-height: 1.6;">
                        KatkÄ±larÄ±nÄ±zdan hiÃ§bir kesinti yapÄ±lmaz, tÃ¼m tutar doÄŸrudan kampanyaya gider.
                    </p>
                </div>
                <div style="padding: 16px; background: white; border-radius: 8px; border-left: 3px solid var(--primary);">
                    <h4 style="font-size: 15px; font-weight: 600; margin-bottom: 8px; color: var(--text-primary);">âœ… Åeffaf Veri</h4>
                    <p style="font-size: 14px; color: var(--text-secondary); line-height: 1.6;">
                        TÃ¼m veriler aÃ§Ä±k ve net bir ÅŸekilde paylaÅŸÄ±lÄ±r, gizlilik her zaman korunur.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Etki HaritasÄ± BÃ¶lÃ¼mÃ¼ -->
    <div class="card" style="margin-top: 32px; overflow: visible;">
        <div class="card-body">
            <h3 style="font-weight: 600; margin-bottom: 8px; color: var(--text-primary); font-size: 20px;">ğŸ—ºï¸ Etki HaritasÄ±</h3>
            <p style="color: var(--text-secondary); margin-bottom: 20px; font-size: 14px;">
                TÃ¼rkiye genelinde yÃ¼rÃ¼tÃ¼len kampanyalarÄ±n coÄŸrafi daÄŸÄ±lÄ±mÄ±. Marker renkleri iyilik alanlarÄ±nÄ± temsil eder.
            </p>
            
            <div id="impact-map" style="height: 500px; width: 100%; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 20px rgba(0,0,0,0.1); z-index: 1; position: relative;"></div>
            
            <!-- BoÅŸ harita mesajÄ± -->
            <div id="map-empty-message" style="display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; background: white; padding: 2rem; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); z-index: 1000;">
                <div style="font-size: 48px; margin-bottom: 1rem;">ğŸ“</div>
                <h4 style="color: var(--text-primary); margin-bottom: 0.5rem;">HenÃ¼z kampanya yok</h4>
                <p style="color: var(--text-secondary); font-size: 14px;">Haritada gÃ¶sterilecek kampanya bulunamadÄ±.</p>
            </div>
            
            <div style="margin-top: 16px; display: flex; flex-wrap: wrap; gap: 12px; justify-content: center;">
                <div style="display: flex; align-items: center; gap: 6px;">
                    <div style="width: 12px; height: 12px; background: #EF4444; border-radius: 50%;"></div>
                    <span style="font-size: 13px; color: var(--text-secondary);">Afet & Acil Durum</span>
                </div>
                <div style="display: flex; align-items: center; gap: 6px;">
                    <div style="width: 12px; height: 12px; background: #3B82F6; border-radius: 50%;"></div>
                    <span style="font-size: 13px; color: var(--text-secondary);">EÄŸitim & Ã‡ocuk</span>
                </div>
                <div style="display: flex; align-items: center; gap: 6px;">
                    <div style="width: 12px; height: 12px; background: #8B5CF6; border-radius: 50%;"></div>
                    <span style="font-size: 13px; color: var(--text-secondary);">Hayvanlar</span>
                </div>
                <div style="display: flex; align-items: center; gap: 6px;">
                    <div style="width: 12px; height: 12px; background: #10B981; border-radius: 50%;"></div>
                    <span style="font-size: 13px; color: var(--text-secondary);">Ã‡evre & DoÄŸa</span>
                </div>
                <div style="display: flex; align-items: center; gap: 6px;">
                    <div style="width: 12px; height: 12px; background: #F59E0B; border-radius: 50%;"></div>
                    <span style="font-size: 13px; color: var(--text-secondary);">GÄ±da & Temel Ä°htiyaÃ§</span>
                </div>
                <div style="display: flex; align-items: center; gap: 6px;">
                    <div style="width: 12px; height: 12px; background: #EC4899; border-radius: 50%;"></div>
                    <span style="font-size: 13px; color: var(--text-secondary);">SaÄŸlÄ±k</span>
                </div>
            </div>
        </div>
    </div>
</div>

@section Styles {
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
         integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
         crossorigin=""/>
    
    <style>
        #impact-map {
            position: relative;
        }
        
        .leaflet-container {
            font-family: 'Inter', sans-serif;
        }
        
        .leaflet-popup-content-wrapper {
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }
        
        .leaflet-popup-content {
            margin: 12px;
            font-family: 'Inter', sans-serif;
        }
        
        .leaflet-popup-tip {
            background: white;
        }
        
        .custom-marker {
            background: transparent !important;
            border: none !important;
        }
    </style>
}

@section Scripts {
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
         integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
         crossorigin=""></script>

    <script>
        (function() {
            'use strict';
            
            console.log('Leaflet harita scripti yÃ¼kleniyor...');
            
            // Åehir koordinatlarÄ±
            const cityCoordinates = {
                'Ä°stanbul': [41.0082, 28.9784],
                'Ankara': [39.9334, 32.8597],
                'Ä°zmir': [38.4237, 27.1428],
                'Antalya': [36.8969, 30.7133],
                'Bursa': [40.1826, 29.0665],
                'Adana': [37.0000, 35.3213],
                'Gaziantep': [37.0662, 37.3833],
                'Konya': [37.8746, 32.4932],
                'MuÄŸla': [37.2153, 28.3636],
                'Mersin': [36.8000, 34.6333],
                'Kayseri': [38.7205, 35.4826],
                'EskiÅŸehir': [39.7767, 30.5206],
                'DiyarbakÄ±r': [37.9144, 40.2306],
                'Samsun': [41.2867, 36.3300],
                'Denizli': [37.7765, 29.0864],
                'ÅanlÄ±urfa': [37.1591, 38.7969],
                'AdapazarÄ±': [40.7569, 30.4030],
                'Malatya': [38.3552, 38.3095],
                'KahramanmaraÅŸ': [37.5858, 36.9371],
                'Erzurum': [39.9000, 41.2700],
                'Van': [38.4891, 43.4089],
                'Batman': [37.8812, 41.1351],
                'ElazÄ±ÄŸ': [38.6810, 39.2264],
                'Trabzon': [41.0027, 39.7168],
                'Manisa': [38.6191, 27.4289],
                'Kocaeli': [40.8533, 29.8815],
                'BalÄ±kesir': [39.6484, 27.8826],
                'Hatay': [36.4018, 36.3498],
                'TekirdaÄŸ': [40.9833, 27.5167],
                'Ã‡orum': [40.5506, 34.9556],
                'AydÄ±n': [37.8560, 27.8416]
            };

            // Kategori renkleri
            const categoryColors = {
                'AfetAcilDurum': '#EF4444',
                'EgitimCocuk': '#3B82F6',
                'Hayvanlar': '#8B5CF6',
                'CevreVeDoga': '#10B981',
                'GidaTemelIhtiyac': '#F59E0B',
                'Saglik': '#EC4899'
            };

            // Kampanya verilerini hazÄ±rla
            const campaignsData = @Html.Raw(ViewBag.CampaignsJson ?? "[]");

            console.log('ğŸ“Š Kampanya verisi:', campaignsData);
            console.log('ğŸ“ˆ Toplam kampanya sayÄ±sÄ±:', campaignsData.length);
            
            if (campaignsData.length === 0) {
                console.error('âŒ UYARI: Kampanya verisi boÅŸ! ViewBag.Campaigns kontrol edilmeli.');
            }

            // HaritayÄ± baÅŸlat
            function initMap() {
                try {
                    console.log('Harita baÅŸlatÄ±lÄ±yor...');
                    console.log('Leaflet yÃ¼klÃ¼ mÃ¼?', typeof L !== 'undefined');
                    
                    // Harita container'Ä± kontrol et
                    const mapContainer = document.getElementById('impact-map');
                    if (!mapContainer) {
                        console.error('Harita container bulunamadÄ±!');
                        return;
                    }
                    
                    console.log('Container bulundu, harita oluÅŸturululuyor...');
                    console.log('Container boyutlarÄ±:', mapContainer.offsetWidth, 'x', mapContainer.offsetHeight);
                    
                    if (campaignsData.length === 0) {
                        console.warn('âš ï¸ Kampanya verisi yok! Harita boÅŸ gÃ¶rÃ¼necek.');
                        // HaritayÄ± yine de oluÅŸtur
                    }
                    
                    // HaritayÄ± oluÅŸtur (varsayÄ±lan zoom kontrolÃ¼ devre dÄ±ÅŸÄ±)
                    const map = L.map('impact-map', {
                        center: [39.0, 35.0],
                        zoom: 6,
                        scrollWheelZoom: true,
                        dragging: true,
                        zoomControl: false
                    });

                    console.log('Harita nesnesi oluÅŸturuldu');

                    // TÃ¼rkÃ§e OpenStreetMap katmanÄ±
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: 'Harita Verileri Â© OpenStreetMap',
                        maxZoom: 18,
                        minZoom: 5
                    }).addTo(map);

                    console.log('Tile layer eklendi');

                    // Tek TÃ¼rkÃ§e zoom kontrolÃ¼
                    L.control.zoom({
                        position: 'topright',
                        zoomInTitle: 'YakÄ±nlaÅŸtÄ±r',
                        zoomOutTitle: 'UzaklaÅŸtÄ±r'
                    }).addTo(map);

                    // Marker sayacÄ±
                    let markerCount = 0;

                    // Her kampanya iÃ§in marker ekle
                    campaignsData.forEach((campaign, index) => {
                        console.log(`Kampanya ${index + 1}:`, campaign);
                        const coords = cityCoordinates[campaign.city];
                        if (coords) {
                            const color = categoryColors[campaign.category] || '#6B7280';
                            
                            // Ã–zel marker ikonu oluÅŸtur
                            const markerIcon = L.divIcon({
                                className: 'custom-marker',
                                html: `<div style="
                                    width: 24px;
                                    height: 24px;
                                    background: ${color};
                                    border: 3px solid white;
                                    border-radius: 50%;
                                    box-shadow: 0 2px 8px rgba(0,0,0,0.3);
                                "></div>`,
                                iconSize: [24, 24],
                                iconAnchor: [12, 12]
                            });

                            const marker = L.marker(coords, { icon: markerIcon }).addTo(map);
                            markerCount++;
                            
                            // Popup iÃ§eriÄŸi
                            const popupContent = `
                                <div style="min-width: 200px;">
                                    <h4 style="margin: 0 0 8px 0; font-size: 14px; font-weight: 700; color: #111827;">${campaign.title}</h4>
                                    <div style="margin-bottom: 6px;">
                                        <span style="font-size: 12px; color: #6B7280; font-weight: 600;">${campaign.categoryDisplayName}</span>
                                    </div>
                                    <div style="margin-bottom: 6px;">
                                        <span style="font-size: 12px; color: #6B7280;">ğŸ“ ${campaign.city}</span>
                                    </div>
                                    <div style="margin-bottom: 4px;">
                                        <span style="font-size: 13px; font-weight: 700; color: #10B981;">â‚º${campaign.raisedAmount.toLocaleString('tr-TR')}</span>
                                        <span style="font-size: 12px; color: #9CA3AF;"> / â‚º${campaign.goalAmount.toLocaleString('tr-TR')}</span>
                                    </div>
                                    <div style="height: 4px; background: #E5E7EB; border-radius: 4px; overflow: hidden; margin-top: 8px;">
                                        <div style="height: 100%; width: ${Math.min((campaign.raisedAmount / campaign.goalAmount) * 100, 100)}%; background: #10B981;"></div>
                                    </div>
                                    ${campaign.isVerified ? '<div style="display: inline-block; padding: 4px 8px; background: rgba(16, 185, 129, 0.15); color: #059669; border-radius: 12px; font-size: 11px; font-weight: 600; margin-top: 8px;">âœ“ DoÄŸrulandÄ±</div>' : ''}
                                </div>
                            `;
                            
                            marker.bindPopup(popupContent);
                        } else {
                            console.warn(`Åehir koordinatlarÄ± bulunamadÄ±: ${campaign.city}`);
                        }
                    });

                    console.log(`âœ… Harita baÅŸarÄ±yla yÃ¼klendi! ${markerCount} marker eklendi.`);
                    
                    if (markerCount === 0) {
                        console.error('âŒ HÄ°Ã‡ MARKER EKLENEMEDÄ°! Kampanya verisi veya ÅŸehir koordinatlarÄ± kontrol edilmeli.');
                        // BoÅŸ harita mesajÄ±nÄ± gÃ¶ster
                        document.getElementById('map-empty-message').style.display = 'block';
                    }

                    // Harita yÃ¼klenme kontrolÃ¼
                    setTimeout(() => {
                        map.invalidateSize();
                    }, 100);

                } catch (error) {
                    console.error('âŒ Harita baÅŸlatma hatasÄ±:', error);
                    document.getElementById('map-empty-message').style.display = 'block';
                }
            }

            // HaritayÄ± baÅŸlat
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initMap);
            } else {
                // DOM zaten yÃ¼klenmiÅŸ
                setTimeout(initMap, 100);
            }
        })();
    </script>
}
